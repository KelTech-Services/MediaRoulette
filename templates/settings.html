<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings | MediaRoulette</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <script>
        const savedTheme = localStorage.getItem('theme') || '{{ default_theme }}';
        document.documentElement.classList.add(savedTheme);
    </script>
    <style>
        .checkbox-dropdown {
            position: relative;
            width: 100%;
        }
        .checkbox-dropdown-toggle {
            width: 100%;
            padding: 12px 14px;
            font-size: 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-primary);
            color: var(--text-primary);
            cursor: pointer;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .checkbox-dropdown-toggle:hover {
            border-color: var(--accent);
        }
        .checkbox-dropdown-toggle::after {
            content: '‚ñº';
            font-size: 10px;
            color: var(--text-secondary);
        }
        .checkbox-dropdown.open .checkbox-dropdown-toggle::after {
            content: '‚ñ≤';
        }
        .checkbox-dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-top: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
        }
        .checkbox-dropdown.open .checkbox-dropdown-menu {
            display: block;
        }
        .checkbox-dropdown-item {
            padding: 10px 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            color: var(--text-primary);
        }
        .checkbox-dropdown-item:hover {
            background: var(--bg-secondary);
        }
        .checkbox-dropdown-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        .checkbox-dropdown-item label {
            cursor: pointer;
            flex: 1;
        }
    </style>
</head>
<body>
<div class="container">

    <div class="top-bar">
        <a href="{{ url_for('index') }}">
            <button type="button">üé≤ Picker</button>
        </a>
        <a href="{{ url_for('watchlist') }}">
            <button type="button">üì∫ Watchlist</button>
        </a>
        <button id="theme-toggle" type="button" onclick="toggleTheme()">‚òÄÔ∏è</button>
    </div>

    <div class="logo-container">
        <img src="{{ url_for('static', filename='img/logo.png') }}" alt="MediaRoulette Logo">
        <h1>Settings</h1>
    </div>

    {% if success %}
    <div style="background: rgba(46, 204, 113, 0.15); color: #2ecc71; padding: 12px 16px; border-radius: 8px; margin-bottom: 24px; text-align: center;">
        Settings saved successfully.
    </div>
    {% endif %}

    <form method="POST">
        <div class="form-row">
            <div class="form-group">
                <label for="plex_server_url">
                    Plex Server
                    <span class="tooltip">‚ùì
                        <span class="tooltiptext">Select the Plex server that contains your media libraries.</span>
                    </span>
                </label>
                <select id="plex_server_url" name="plex_server_url" required>
                    {% if servers %}
                        {% for server in servers %}
                            <option value="{{ server.uri }}" {% if config.plex_server_url == server.uri %}selected{% endif %}>{{ server.name }}</option>
                        {% endfor %}
                    {% else %}
                        <option disabled selected>No servers available</option>
                    {% endif %}
                </select>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label>
                    Movie Libraries
                    <span class="tooltip">‚ùì
                        <span class="tooltiptext">Select one or more libraries containing your movies. Leave unselected to exclude movies from results.</span>
                    </span>
                </label>
                <div class="checkbox-dropdown" id="movies-dropdown">
                    <button type="button" class="checkbox-dropdown-toggle" onclick="toggleDropdown('movies-dropdown')">
                        <span class="selected-text">Select libraries...</span>
                    </button>
                    <div class="checkbox-dropdown-menu">
                        {% for lib in libraries %}
                        <div class="checkbox-dropdown-item">
                            <input type="checkbox" name="movies_library" value="{{ lib.title }}" id="movies_{{ loop.index }}"
                                {% if lib.title in config.get('movies_libraries', []) or (not config.get('movies_libraries') and config.movies_library == lib.title) %}checked{% endif %}
                                onchange="updateDropdownText('movies-dropdown')">
                            <label for="movies_{{ loop.index }}">{{ lib.title }}</label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>
                    TV Show Libraries
                    <span class="tooltip">‚ùì
                        <span class="tooltiptext">Select one or more libraries containing your TV shows. Leave unselected to exclude TV shows from results.</span>
                    </span>
                </label>
                <div class="checkbox-dropdown" id="tvshows-dropdown">
                    <button type="button" class="checkbox-dropdown-toggle" onclick="toggleDropdown('tvshows-dropdown')">
                        <span class="selected-text">Select libraries...</span>
                    </button>
                    <div class="checkbox-dropdown-menu">
                        {% for lib in libraries %}
                        <div class="checkbox-dropdown-item">
                            <input type="checkbox" name="tvshows_library" value="{{ lib.title }}" id="tvshows_{{ loop.index }}"
                                {% if lib.title in config.get('tvshows_libraries', []) or (not config.get('tvshows_libraries') and config.tvshows_library == lib.title) %}checked{% endif %}
                                onchange="updateDropdownText('tvshows-dropdown')">
                            <label for="tvshows_{{ loop.index }}">{{ lib.title }}</label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="default_theme">
                    Theme
                    <span class="tooltip">‚ùì
                        <span class="tooltiptext">Choose your preferred color scheme. You can also toggle this using the button in the top bar.</span>
                    </span>
                </label>
                <select id="default_theme" name="default_theme" onchange="applyThemeFromDropdown()">
                    <option value="dark" {% if config.default_theme == 'dark' %}selected{% endif %}>Dark</option>
                    <option value="light" {% if config.default_theme == 'light' %}selected{% endif %}>Light</option>
                </select>
            </div>

            <div class="form-group">
                <label>
                    Session History
                    <span class="tooltip">‚ùì
                        <span class="tooltiptext">When enabled, your recent picks are saved during your browsing session for easy reference.</span>
                    </span>
                </label>
                <div style="padding-top: 12px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="enable_history" name="enable_history"
                               {% if config.enable_history != false %}checked{% endif %}>
                        <span style="color: var(--text-secondary);">Save recent picks</span>
                    </label>
                </div>
            </div>
        </div>

        <button type="submit">üíæ Save Settings</button>
    </form>

    <div style="margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--border);">
        <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
            <form method="POST" action="{{ url_for('reset_password') }}" onsubmit="return confirm('Are you sure? This will delete your admin account and require you to create a new one.');">
                <button type="submit" title="This deletes your admin account entirely. You will need to create a new username and password on the next page load." style="background: #cc7700; border: none; width: auto; padding: 12px 24px;">
                    üîë Reset Password
                </button>
            </form>
            <form method="GET" action="{{ url_for('signout') }}">
                <button type="submit" style="background: #cc3333; border: none; width: auto; padding: 12px 24px;">
                    üîå Disconnect Plex
                </button>
            </form>
            <form method="GET" action="{{ url_for('app_logout') }}">
                <button type="submit" style="background: #666; border: none; width: auto; padding: 12px 24px;">
                    üö™ Log Out
                </button>
            </form>
        </div>
    </div>

    <section style="margin-top: 48px; padding-top: 24px; border-top: 1px solid var(--border);">
        <h2 style="font-size: 18px; margin-bottom: 16px; color: var(--text-primary);">About These Settings</h2>
        
        <p style="margin-bottom: 12px; color: var(--text-secondary); line-height: 1.6;">
            <strong style="color: var(--text-primary);">Plex Server:</strong> 
            This dropdown lists all Plex servers linked to your account. Select the server that contains your movie and TV show libraries.
        </p>
        
        <p style="margin-bottom: 12px; color: var(--text-secondary); line-height: 1.6;">
            <strong style="color: var(--text-primary);">Movie Libraries / TV Show Libraries:</strong> 
            Select one or more libraries from your Plex server using the checkbox dropdowns. Leave a category unselected to exclude that media type from results.
        </p>
        
        <p style="margin-bottom: 12px; color: var(--text-secondary); line-height: 1.6;">
            <strong style="color: var(--text-primary);">Theme:</strong> 
            Select your preferred appearance. This setting is saved and will persist across sessions.
        </p>
        
        <p style="margin-bottom: 12px; color: var(--text-secondary); line-height: 1.6;">
            <strong style="color: var(--text-primary);">Session History:</strong> 
            When enabled, MediaRoulette keeps track of your last 20 picks. You can view or clear your history from the main picker page.
        </p>
        
        <p style="margin-bottom: 0; color: var(--text-secondary); line-height: 1.6;">
            <strong style="color: var(--text-primary);">Reset Password:</strong> 
            This deletes your admin account entirely. You will need to create a new username and password, and reconnect to Plex on the next page load.
        </p>
    </section>

</div>

<script>
    function toggleDropdown(dropdownId) {
        const dropdown = document.getElementById(dropdownId);
        // Close other dropdowns
        document.querySelectorAll('.checkbox-dropdown.open').forEach(d => {
            if (d.id !== dropdownId) d.classList.remove('open');
        });
        dropdown.classList.toggle('open');
    }

    function updateDropdownText(dropdownId) {
        const dropdown = document.getElementById(dropdownId);
        const checkboxes = dropdown.querySelectorAll('input[type="checkbox"]:checked');
        const textSpan = dropdown.querySelector('.selected-text');
        if (checkboxes.length === 0) {
            textSpan.textContent = 'Select libraries...';
        } else if (checkboxes.length === 1) {
            textSpan.textContent = checkboxes[0].nextElementSibling.textContent;
        } else {
            textSpan.textContent = checkboxes.length + ' libraries selected';
        }
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.checkbox-dropdown')) {
            document.querySelectorAll('.checkbox-dropdown.open').forEach(d => d.classList.remove('open'));
        }
    });

    function toggleTheme() {
        const html = document.documentElement;
        const toggleBtn = document.getElementById('theme-toggle');
        const dropdown = document.getElementById('default_theme');
        const newTheme = html.classList.contains('dark') ? 'light' : 'dark';
        html.classList.remove('dark', 'light');
        html.classList.add(newTheme);
        localStorage.setItem('theme', newTheme);
        if (toggleBtn) toggleBtn.innerText = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        if (dropdown) dropdown.value = newTheme;
    }

    function applyThemeFromDropdown() {
        const selectedTheme = document.getElementById('default_theme').value;
        document.documentElement.classList.remove('dark', 'light');
        document.documentElement.classList.add(selectedTheme);
        localStorage.setItem('theme', selectedTheme);
        const toggleBtn = document.getElementById('theme-toggle');
        if (toggleBtn) toggleBtn.innerText = selectedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    }

    async function onServerChange() {
        const serverUri = document.getElementById('plex_server_url').value;
        const moviesMenu = document.querySelector('#movies-dropdown .checkbox-dropdown-menu');
        const tvMenu = document.querySelector('#tvshows-dropdown .checkbox-dropdown-menu');

        // Show loading state
        moviesMenu.innerHTML = '<div class="checkbox-dropdown-item">Loading...</div>';
        tvMenu.innerHTML = '<div class="checkbox-dropdown-item">Loading...</div>';
        updateDropdownText('movies-dropdown');
        updateDropdownText('tvshows-dropdown');

        try {
            const response = await fetch('/api/server_libraries/' + encodeURIComponent(serverUri));
            const data = await response.json();

            if (data.error) {
                moviesMenu.innerHTML = '<div class="checkbox-dropdown-item">Error loading libraries</div>';
                tvMenu.innerHTML = '<div class="checkbox-dropdown-item">Error loading libraries</div>';
                console.error('Error fetching libraries:', data.error);
                return;
            }

            // Populate movies dropdown
            moviesMenu.innerHTML = '';
            data.libraries.forEach((lib, index) => {
                const item = document.createElement('div');
                item.className = 'checkbox-dropdown-item';
                item.innerHTML = `
                    <input type="checkbox" name="movies_library" value="${lib.title}" id="movies_new_${index}" onchange="updateDropdownText('movies-dropdown')">
                    <label for="movies_new_${index}">${lib.title}</label>
                `;
                moviesMenu.appendChild(item);
            });

            // Populate TV shows dropdown
            tvMenu.innerHTML = '';
            data.libraries.forEach((lib, index) => {
                const item = document.createElement('div');
                item.className = 'checkbox-dropdown-item';
                item.innerHTML = `
                    <input type="checkbox" name="tvshows_library" value="${lib.title}" id="tvshows_new_${index}" onchange="updateDropdownText('tvshows-dropdown')">
                    <label for="tvshows_new_${index}">${lib.title}</label>
                `;
                tvMenu.appendChild(item);
            });

            updateDropdownText('movies-dropdown');
            updateDropdownText('tvshows-dropdown');

        } catch (e) {
            console.error('Failed to fetch libraries:', e);
            moviesMenu.innerHTML = '<div class="checkbox-dropdown-item">Error loading libraries</div>';
            tvMenu.innerHTML = '<div class="checkbox-dropdown-item">Error loading libraries</div>';
        }
    }

    window.onload = () => {
        const savedTheme = localStorage.getItem('theme') || '{{ default_theme }}';
        document.documentElement.classList.remove('dark', 'light');
        document.documentElement.classList.add(savedTheme);
        const toggleBtn = document.getElementById('theme-toggle');
        const dropdown = document.getElementById('default_theme');
        if (toggleBtn) toggleBtn.innerText = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        if (dropdown) dropdown.value = savedTheme;

        // Initialize checkbox dropdown text
        updateDropdownText('movies-dropdown');
        updateDropdownText('tvshows-dropdown');

        // Add change listener to server dropdown
        const serverSelect = document.getElementById('plex_server_url');
        if (serverSelect) {
            serverSelect.addEventListener('change', onServerChange);
        }
    };
</script>
</body>
</html>
